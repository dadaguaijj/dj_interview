# Django主机管理系统 - 解题思路

## 项目概述

本项目是一个基于Django和Celery的企业内部主机管理系统，实现了主机、城市、机房的管理，以及密码自动更新、统计分析和请求监控等功能。

## 技术架构设计

### 1. 模块化设计

采用Django应用模块化设计，将功能拆分为独立的应用：

- **host_management**: 核心业务逻辑模块
  - `models.py`: 数据模型定义
  - `serializers.py`: DRF序列化器
  - `celery_tasks.py`: Celery定时任务
  - `utils.py`: 工具函数
  - `admin.py`: Django Admin配置

- **api**: API接口模块
  - `views.py`: API视图集
  - `urls.py`: API路由配置

这种设计便于代码维护、功能扩展和团队协作。

### 2. 数据模型设计

#### 2.1 核心模型

**City（城市）**
- 字段：name（名称）、code（代码）、description（描述）
- 用途：管理城市信息

**DataCenter（机房）**
- 字段：name（名称）、code（代码）、city（外键关联城市）、address（地址）
- 用途：管理机房信息，与城市建立多对一关系

**Host（主机）**
- 字段：hostname（主机名）、ip_address（IP地址）、city（外键）、data_center（外键）、status（状态）、硬件信息等
- 用途：管理主机信息，建立城市-机房-主机三级关系

#### 2.2 扩展模型

**HostPassword（主机密码）**
- 字段：host（一对一关联）、encrypted_password（加密密码）、password_changed_at（修改时间）
- 特点：
  - 使用Fernet对称加密存储密码
  - 提供加密/解密方法
  - 密码不直接暴露在API中

**HostStatistics（主机统计）**
- 字段：city、data_center、host_count（主机总数）、active_host_count（运行中数量）、statistics_date（统计日期）
- 特点：
  - 按城市和机房维度统计
  - 支持唯一约束（city + data_center + date）
  - 定时任务自动生成

**RequestLog（请求日志）**
- 字段：path、method、status_code、duration_ms（耗时）、ip_address、user_agent
- 特点：
  - 记录所有API请求的详细信息
  - 支持索引优化查询
  - 中间件自动记录

### 3. API接口设计

使用Django REST Framework实现RESTful API：

#### 3.1 ViewSet设计

- **CityViewSet**: 城市CRUD操作
- **DataCenterViewSet**: 机房CRUD操作（支持按城市过滤）
- **HostViewSet**: 主机CRUD操作（支持多维度过滤）
  - 额外action: `ping` - 探测主机连通性
- **HostPasswordViewSet**: 密码记录查询（只读，不返回实际密码）
- **HostStatisticsViewSet**: 统计数据查询（只读，支持多维度过滤）

#### 3.2 序列化器设计

- 使用嵌套序列化器展示关联对象信息
- 使用`write_only`字段处理外键关联
- 实现数据验证（如城市和机房的关联关系验证）

### 4. 密码加密方案

#### 4.1 加密算法选择

使用`cryptography`库的Fernet对称加密：
- 优点：简单易用、安全性高、支持密钥轮换
- 实现：每个密码记录独立加密存储

#### 4.2 密钥管理

- 优先从环境变量`ENCRYPTION_KEY`获取
- 其次从Django settings获取
- 开发环境自动生成并缓存（生产环境必须配置）

#### 4.3 安全措施

- API不返回实际密码
- 密码字段在Admin中设为只读
- 密码修改时间自动记录

### 5. Ping探测功能

#### 5.1 实现方式

使用Python的`subprocess`模块调用系统ping命令：
- Windows: `ping -n 1 -w {timeout}ms {ip}`
- Linux/Mac: `ping -c 1 -W {timeout}s {ip}`

#### 5.2 跨平台兼容

- 自动检测操作系统
- 使用不同的ping命令参数
- 统一返回格式

#### 5.3 错误处理

- 超时处理
- 异常捕获
- 返回详细错误信息

### 6. Celery定时任务

#### 6.1 任务设计

**update_host_passwords（密码更新任务）**
- 执行频率：每8小时
- 功能：
  1. 遍历所有主机
  2. 为每台主机生成16位随机密码
  3. 加密并更新密码记录
  4. 记录操作日志

**generate_host_statistics（统计任务）**
- 执行频率：每天00:00
- 功能：
  1. 遍历所有城市和机房组合
  2. 统计每个组合的主机总数和运行中数量
  3. 创建或更新统计记录
  4. 记录操作日志

#### 6.2 Celery配置

- Broker: Redis
- Result Backend: Redis
- 时区：Asia/Shanghai
- 任务序列化：JSON

#### 6.3 定时调度

使用Celery Beat实现定时调度：
- 密码更新：固定间隔（28800秒）
- 统计任务：使用crontab格式（每天00:00）

### 7. 中间件设计

#### 7.1 RequestTimingMiddleware

**功能**：
- 记录每个请求的开始时间
- 计算请求处理耗时
- 保存请求日志到数据库

**实现要点**：
- 使用`process_request`记录开始时间
- 使用`process_response`计算耗时并保存
- 异常处理不影响正常响应
- 支持获取客户端IP和User Agent

**性能考虑**：
- 数据库写入是同步的（生产环境可改为异步）
- 记录失败不影响API响应

### 8. 数据库设计优化

#### 8.1 索引设计

- RequestLog模型添加时间索引和路径索引
- 外键字段自动创建索引

#### 8.2 唯一约束

- City.code: 唯一
- DataCenter: (city, name) 唯一
- HostStatistics: (city, data_center, statistics_date) 唯一

#### 8.3 查询优化

- 使用select_related减少查询次数
- 支持多维度过滤查询

## 关键技术点

### 1. 模块化架构

- 业务逻辑与API分离
- 工具函数独立模块
- 中间件独立模块
- 任务独立模块

### 2. 安全性设计

- 密码加密存储
- API不暴露敏感信息
- 环境变量管理密钥

### 3. 可扩展性

- RESTful API设计
- 支持多维度过滤
- 易于添加新功能

### 4. 可维护性

- 代码结构清晰
- 注释完善
- 日志记录完善

## 部署注意事项

### 1. 环境配置

- 必须配置`ENCRYPTION_KEY`环境变量（生产环境）
- 配置Redis服务
- 配置数据库连接

### 2. Celery部署

- 启动Worker: `celery -A host_management worker -l info`
- 启动Beat: `celery -A host_management beat -l info`
- 建议使用supervisor或systemd管理进程

### 3. 数据库迁移

- 首次部署执行`makemigrations`和`migrate`
- 后续更新注意数据迁移兼容性

### 4. 性能优化

- 生产环境使用PostgreSQL或MySQL
- 配置Redis持久化
- 考虑使用异步任务队列（如Celery + Redis）
- 添加API限流和缓存

## 测试建议

### 1. 单元测试

- 模型方法测试
- 工具函数测试
- 序列化器验证测试

### 2. 集成测试

- API接口测试
- Celery任务测试
- 中间件功能测试

### 3. 性能测试

- 大量数据下的查询性能
- 并发请求处理能力
- Celery任务执行效率

## 总结

本项目实现了题目要求的所有功能：

1. ✅ 主机管理系统（城市、机房、主机模型）
2. ✅ 增删改查API接口
3. ✅ Ping探测API
4. ✅ 密码自动更新（每8小时）
5. ✅ 统计分析（每天00:00）
6. ✅ 请求耗时统计中间件

采用模块化设计，代码结构清晰，易于维护和扩展。所有功能都经过精心设计，考虑了安全性、性能和可扩展性。

